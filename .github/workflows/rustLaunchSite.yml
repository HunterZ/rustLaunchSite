name: Builder rustLaunchSite

on:
  push:
  pull_request:
    branches: [ $default-branch ]
  workflow_dispatch:

# needed for vcpkg caching
permissions:
  contents: write

# needed for vcpkg caching
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  VCPKG_FEATURE_FLAGS: dependencygraph

jobs:
  rustLaunchSite:
    strategy:
      matrix:
        # only Windows for now
        os: [ windows-latest ]
        # only MinSizeRel for now
        buildtype: [ minsizerel ]
        include:
          # unique set of triplet base(s) for each OS
          # NOTES:
          # - at least one triplet base must be defined per OS
          # - tripletbase is matrixed with buildtype to form triplets
          - os: windows-latest
            tripletbase: x64-mingw-static

    name: ${{ github.workflow }}.${{ matrix.os }}.${{ matrix.tripletbase }}-${{ matrix.buildtype }}
    runs-on: ${{ matrix.os }}

    defaults:
      # use MSYS2 bash as the default shell
      run:
        shell: msys2 {0}

    env:
      # keep everyone on the same page regarding triplet when running vcpkg
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.tripletbase }}-${{ matrix.buildtype }}
      VCPKG_DEFAULT_HOST_TRIPLET: ${{ matrix.tripletbase }}-${{ matrix.buildtype }}

    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2.22.0
        with:
          msystem: MINGW64
          update: true
          install: >-
            curl
            git
            make
          pacboy: >-
            cmake:p
            ninja:p
            toolchain:p

      - name: Add MinGW64 to MSYS2 shell PATH
        run: export PATH="${RUNNER_TEMP}/msys64/mingw64/bin:${PATH}"

      # - name: Capture diagnostic info
      #   run: |
      #     which cmake && cmake --version
      #     which git && git --version
      #     which gcc && gcc --version
      #     set

      - name: Setup git line endings
        run: git config --global core.autocrlf input

      - name: Setup submodules
        uses: actions/checkout@v4.1.1
        with:
          submodules: true

      - name: CMake configure
        run: cmake --preset ${{ matrix.tripletbase }}-${{ matrix.buildtype }}

      - name: CMake build
        run: cmake --build "${{ github.workspace }}/out/build/${{ matrix.tripletbase }}-${{ matrix.buildtype }}"
